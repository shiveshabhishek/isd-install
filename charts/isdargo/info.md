# enterprise-argo 


## helm install 

For installing the Argo CD Please follow the below document

https://docs.google.com/document/d/1mvOzxzXujt9Gs6GTZKJSbstDwoaV5e8UbyeHNF6Fq4U/edit#

https://docs.google.com/document/d/1GWiyWp5e6v92x4quemc4W_-kWfx-hpzvxVnbEIBsTIk/edit#

   - **Troubleshooting**

- While installing if u face this error Unable to continue with install: CustomResourceDefinition "analysisruns.argoproj.io"

- Please updated values.yaml with `argo-rollouts.installCRDs: false` and perform helm install.

- While installing if u face this error Unable to continue with install: CustomResourceDefinition  "eventsources.argoproj.io"

- Please updated values.yaml with `argo-events.crds.install: false` and perform helm install.



## Documents:

- **Carina Service:**

  https://docs.google.com/document/d/1Ovp9PYRQiGzcgCUxd7sQWurlJXd9lpNPhZvG5fgK4xkubectl/edit
  
- **Agent configuration:**

  https://docs.google.com/document/d/1gAzG8hyQFqwAq5GOMlgIHK_5wE0lOweHsq5miyYrd6o/edit#heading=h.or0u4en44o5l
  
  **Exel sheet**

  https://docs.google.com/spreadsheets/d/19wuRoz0S9f_5t8pRnal6dlU6SpZWIq3AMNFWCVR2r9c/edit#gid=0

## Installation:

- **Create opsmx11 secret:**

   Below Secret need to be created Please updated the password and create a secret

      kubectl create secret docker-registry opsmx11-secret --docker-server=docker.io --docker-username=opsmx11 --docker-password=xxxxx --docker-email=saiteja.katabhatina@opmx.io


## Troubleshooting:


- **Unable to add agent in UI:**

  If you are unable to add- **Replace the OEA service images:** agent and if you face below in UI
  
      ERROR
      could not execute statement; SQL [n/a]; constraint [spinnaker_id" of relation "generic_agent]; nested exception is org.hibernate.exception.ConstraintViolationException: could not execute statement
  
  **solution**
  
  - login to oea-db-0 pod and execute the below commands

        kubectl exec -it oea-db-0   -n NAMESPACE  -- bash
        
     execute the commands
     
        bash-4.4$ psql
        oesdb=#
        oesdb=# ALTER TABLE generic_agent ALTER COLUMN spinnaker_id drop not null;
        
  - continue to delete **UNIQUE CONSTRAINT** which solve multiple argocd addition applition names unique name  contrain (ignores unique app name in argo)

        oesdb=# \c platformdb;
        You are now connected to database "platformdb" as user "oesdb".
        
        platformdb=# \d applications;
        
    try to delete the **UNIQUE CONSTRAINT** in the below table        
        
        
                                                Table "public.applications"
              Column     |            Type             | Collation | Nullable |             Default              
          ---------------+-----------------------------+-----------+----------+----------------------------------
           id            | integer                     |           | not null | generated by default as identity
           created_at    | timestamp without time zone |           | not null | 
           updated_at    | timestamp without time zone |           | not null | 
           description   | character varying(255)      |           |          | 
           email         | character varying(255)      |           |          | 
           name          | character varying(255)      |           | not null | 
           source        | character varying(32)       |           |          | 'Autopilot'::character varying
           agent_name    | text                        |           |          | 
           source_name   | text                        |           |          | 
           source_url_ui | text                        |           |          | 
          Indexes:
              "applications_pkey" PRIMARY KEY, btree (id)
              "uk_ghs1q6xciwjy5iijm3w1474r1" UNIQUE CONSTRAINT, btree (name)
              
              
    find and delete in the index section        


          platformdb=# ALTER TABLE applications DROP constraint uk_ghs1q6xciwjy5iijm3w1474r1;
          ALTER TABLE

- **Unable to Connect Argo CD with Agent:**
    
   - Execute below command by logging into the Carina pod will get the detail info

         curl localhost:8090/health | jq .

    

